{% extends "base/base.html" %}

{% load static %}
{% load price_filters %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}

<div class="product-page">

  <div class="product-layout">

    <!-- Columna principal -->
    <section>
      <div class="product-main">
        {% if request.session.catalog_return_url %}
            <a class="back-link" href="{{ request.session.catalog_return_url }}">
                ‚Üê Volver al cat√°logo
            </a>
        {% else %}
            <a class="back-link" href="{{ catalog_url }}">
                ‚Üê Ver cat√°logo
            </a>
        {% endif %}
        <h1 class="product-title-mobile">{{ product.name }}</h1>

        <!-- Galer√≠a -->
        <div class="product-gallery">

          <!-- Thumbnails (desktop: max 5 + "+N" si hay m√°s) -->
          <div class="gallery-thumbs">
            {% for media in media_items|slice:":5" %}
              {% if media.media_type == "image" %}
                <img
                  src="{{ media.image.url }}"
                  class="thumb {% if forloop.first %}active{% endif %}"
                  data-index="{{ forloop.counter0 }}"
                  alt=""
                >
              {% else %}
                <div
                  class="thumb video-thumb {% if forloop.first %}active{% endif %}"
                  data-index="{{ forloop.counter0 }}"
                >
                  ‚ñ∂
                </div>
              {% endif %}
            {% endfor %}
            {% if media_items|length > 5 %}
              <div class="thumb thumb-extra" data-index="5" role="button" tabindex="0" aria-label="Ver m√°s medios">
                +{{ media_items|length|add:"-5" }}
              </div>
            {% endif %}
          </div>
        
          <!-- Viewer -->
          <div class="gallery-viewer" id="galleryViewer">
            <div class="slides-track">
            
              {% for media in media_items %}
                {% if media.media_type == "image" %}
                  <img
                    src="{{ media.image.url }}"
                    class="slide"
                    data-index="{{ forloop.counter0 }}"
                  >
                {% else %}
                  <video
                    class="slide"
                    data-index="{{ forloop.counter0 }}"
                    controls
                  >
                    <source src="{{ media.video.url }}">
                  </video>
                {% endif %}
              {% endfor %}
                
            </div>
          
            <!-- Flechas desktop -->
            <button class="nav-arrow prev" aria-label="Anterior">‚Äπ</button>
            <button class="nav-arrow next" aria-label="Siguiente">‚Ä∫</button>
            
            <!-- Dots mobile -->
            <div class="gallery-dots">
              {% for media in media_items %}
                <span
                  class="dot {% if forloop.first %}active{% endif %}"
                  data-index="{{ forloop.counter0 }}"
                ></span>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Info -->
        <div class="info-box">
          <h1 class="product-title-desktop">{{ product.name }}</h1>
          <strong><p class="product-price">{% if product.price and product.price > 0 %}${{ product.price|ars }}{% else %}Consultar precio{% endif %}</p></strong>
          <div class="product-description">
            {{ product.description|linebreaks }}
          </div>
        </div>
      </div>
    </section>

    <!-- Sidebar compra -->
    <aside class="product-sidebar">
      {% if has_links %}
      <h3>ü°´   Comprar   ü°´</h3>
      <ul>
        {% for link in links %}
          <li>
            <a
              href="{{ link.get_url }}"
              target="_blank"
              class="btn btn-{{ link.link_type }}"
            >
              {{ link.button_text }}
            </a>
          </li>        
        {% endfor %}
      </ul>
      {% if product.stock is not None and product.stock == 0 %}
        <p class="unavailable-product">Sin stock</p>
      {% else %}
        {% if product.stock is not None and product.stock > 0 %}
          <p class="product-stock-available">{{ product.stock }} disponibles</p>
        {% endif %}
        <form method="post" action="{% url 'catalog:cart_add' %}" class="product-add-to-cart">
          {% csrf_token %}
          <input type="hidden" name="product_id" value="{{ product.id }}">
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <div class="product-add-to-cart-row">
            <label for="product-qty-{{ product.id }}" class="product-add-to-cart-label">Cantidad:</label>
            <div class="product-qty-stepper">
              <input type="number" name="quantity" id="product-qty-{{ product.id }}" value="1" min="1" max="{{ max_cart_quantity }}" class="product-qty-input">
              <div class="product-qty-stepper-btns" aria-hidden="true">
                <button type="button" class="qty-minus" aria-label="Menos">‚àí</button>
                <button type="button" class="qty-plus" aria-label="M√°s">+</button>
              </div>
            </div>
          </div>
          <div class="product-add-to-cart-btn-row">
            <button type="submit" class="btn btn-cart">Agregar al carrito</button>
          </div>
        </form>
      {% endif %}
      {% else %}
        <p class="unavailable-product">Producto no disponible</p>
      {% endif %}
    </aside>
      


  </div>

</div>

{% endblock %}

{% block extra_js %}
{{ media_items_json|json_script:"mediaItemsJson" }}
<script src="{% static 'js/product_qty_stepper.js' %}"></script>
<script src="{% static 'js/gallery_maximizer.js' %}"></script>
{% endblock %}
